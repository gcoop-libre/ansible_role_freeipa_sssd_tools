---

- name: Start/Restart FreeIPA SSSD Services
  hosts: [all]
  gather_facts: false
  become: yes

  vars:
    freeipa_sssd_tools_service_facts_populate: true
    freeipa_sssd_tools_service_sssd_stop: false
    freeipa_sssd_tools_no_log: false
    dirsrv_domain: "{{ ipa_domain | default('ipa.example.com') | upper | replace('.', '-') }}"
    freeipa_sssd_tools_services:
      - dirsrv@
      - dirsrv@{{ dirsrv_domain }}
      - httpd
      - ipa
      - ipa-api-syn
      - ipa-custodia
      - ipa-dnskeysyncd
      - ipa-ods-exporter
      - ipa-otpd@
      - ipa-otpd@0
      - ipa-que-syn
      - kadmin
      - krb5kdc
      - named-pkcs11
      - named-setup-rndc
      - ntpd
      - ntpdate
      - sssd
      - sssd-autofs
      - sssd-ifp
      - sssd-nss
      - sssd-pac
      - sssd-pam
      - sssd-secrets
      - sssd-ssh
      - sssd-sudo

  tasks:

    - name: (freeipa_sssd_tools) populate service facts
      service_facts:
      no_log: "{{ freeipa_sssd_tools_no_log | bool }}"
      when: freeipa_sssd_tools_service_facts_populate | bool

    - name: (freeipa_sssd_tools) stopped SSSD when IPA is stopped
      service:
        name: sssd
        state: stopped
      when:
        - freeipa_sssd_tools_service_sssd_stop | bool
        - ansible_facts.services['dirsrv@.service'].state == 'unknown'
        - ansible_facts.services['ipa.service'].state == 'stopped'
        - ansible_facts.services['ntpd.service'].state == 'stopped'
        - ansible_facts.services['sssd.service'].state == 'running'

    - name: (freeipa_sssd_tools) populate service facts
      service_facts:
      no_log: "{{ freeipa_sssd_tools_no_log | bool }}"
      when: freeipa_sssd_tools_service_facts_populate | bool
