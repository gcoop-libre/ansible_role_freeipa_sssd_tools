---

- name: Start/Restart FreeIPA SSSD Services
  hosts: [all]
  gather_facts: false
  become: yes

  vars:
    freeipa_sssd_tools_service_facts_populate: true
    freeipa_sssd_tools_service_sssd_stop: false
    freeipa_sssd_tools_no_log: false
    freeipa_sssd_tools_ipactl_bin: /usr/sbin/ipactl
    freeipa_sssd_tools_ipactl_ignore_service_failure: false
    freeipa_sssd_tools_ipactl_start: true
    freeipa_sssd_tools_ipactl_start_cmd: "{{ freeipa_sssd_tools_ipactl_bin }} start"
    dirsrv_domain: "dirsrv@{{ ipa_domain | default('ipa.example.com') | upper | replace('.', '-') }}.service"
    freeipa_sssd_tools_services:
      - dirsrv@
      - "{{ dirsrv_domain }}"
      - httpd
      - ipa
      - ipa-api-syn
      - ipa-custodia
      - ipa-dnskeysyncd
      - ipa-ods-exporter
      - ipa-otpd@
      - ipa-otpd@0
      - ipa-que-syn
      - kadmin
      - krb5kdc
      - named-pkcs11
      - named-setup-rndc
      - ntpd
      - ntpdate
      - sssd
      - sssd-autofs
      - sssd-ifp
      - sssd-nss
      - sssd-pac
      - sssd-pam
      - sssd-secrets
      - sssd-ssh
      - sssd-sudo

  tasks:

    - name: (freeipa_sssd_tools) populate service facts
      service_facts:
      no_log: "{{ freeipa_sssd_tools_no_log | bool }}"
      when: freeipa_sssd_tools_service_facts_populate | bool

    - name: (freeipa_sssd_tools) stopped SSSD when IPA is stopped
      service:
        name: sssd
        state: stopped
      when:
        - freeipa_sssd_tools_service_sssd_stop | bool
        - ansible_facts.services['dirsrv@.service'].state == 'unknown'
        - ansible_facts.services['{{ dirsrv_domain }}'].state == 'stopped'
        - ansible_facts.services['ipa.service'].state == 'stopped'
        - ansible_facts.services['ntpd.service'].state == 'stopped'
        - ansible_facts.services['sssd.service'].state == 'running'

    - name: (freeipa_sssd_tools) populate service facts
      service_facts:
      no_log: "{{ freeipa_sssd_tools_no_log | bool }}"
      when: freeipa_sssd_tools_service_facts_populate | bool

    - name: (freeipa_sssd_tools) define ipactl start command
      set_fact:
        freeipa_sssd_tools_ipactl_start_cmd: >
          {{ freeipa_sssd_tools_ipactl_bin }} start --ignore-service-failure
      when: freeipa_sssd_tools_ipactl_ignore_service_failure | bool

    - name: (freeipa_sssd_tools) define service dirsrv domain state
      set_fact:
        freeipa_sssd_tools_service_dirsrv_domain_state: "{{ ansible_facts.services['{{ dirsrv_domain }}'].state }}"

    - name: (freeipa sssd tools) debug conditionals
      debug:
        msg: "{{ item }}"
        verbosity: 2
      with_items:
        - "{{ freeipa_sssd_tools_ipactl_start }}"
        - "{{ freeipa_sssd_tools_ipactl_start_cmd }}"
        - "{{ ansible_facts.services['dirsrv@.service'].state }}"
        - "{{ freeipa_sssd_tools_service_dirsrv_domain_state }}"
        - "{{ ansible_facts.services['ipa.service'].state }}"
        - "{{ ansible_facts.services['ntpd.service'].state }}"
        - "{{ ansible_facts.services['sssd.service'].state }}"

    - name: (freeipa_sssd_tools) start IPA services
      command: "{{ freeipa_sssd_tools_ipactl_start_cmd }}"
      when:
        - freeipa_sssd_tools_ipactl_start | bool
        - freeipa_sssd_tools_ipactl_start_cmd is defined
        - freeipa_sssd_tools_ipactl_start_cmd | length > 0
        - ansible_facts.services['dirsrv@.service'].state == 'unknown'
        - freeipa_sssd_tools_service_dirsrv_domain_state == 'stopped'
        - ansible_facts.services['ipa.service'].state == 'stopped'
        - ansible_facts.services['ntpd.service'].state == 'stopped'
        - ansible_facts.services['sssd.service'].state == 'stopped'
